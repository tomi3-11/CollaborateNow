
{% extends 'accounts/base.html' %}

{% block title %}
    {{ project.title }} - Project Details
{% endblock %}

{% block content %}

    <h2>{{ project.title }}</h2>

    <section>
        <h3>Members</h3>
        <ul>
            {% for member in Members %}
                <li>
                    <a href="{% url 'accounts:profile' %}">{{ member.user.username }}</a>
                </li>
            {% empty %}
                <li>No members yet.</li>
            {% endfor %}
        </ul>

        

        {% if user.is_authenticated and is_member and user != project.creator %}

            <form action="{% url 'accounts:leave_project' project.id %}" method="post">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('Are you sure you want to leave this project?')">Leave project</button>
            </form>

        {% endif %}

    </section>

    <section>
    <h3>Project Details</h3>
        {% if project.objectives %}
            <p><strong>Objectives: </strong>{{ project.objectives|linebreaksbr }}</p>
        {% endif %}

        {% if project.rules %}
            <p><strong>Rules: </strong>{{ project.rules|linebreaksbr }}</p>
        {% endif %}

        {% if project.goals %}
            <p><strong>Goals: </strong>{{ project.goals|linebreaksbr }}</p>
        {% endif %}

        {% if project.start_time %}
            <p><strong>Start Time: </strong>{{ project.start_time }}</p>
        {% endif %}

        {% if project.operation_days %}
            <p><strong>Operation Days: </strong>{{ project.operation_days }}</p>
        {% endif %}

        {% if project.deadline %}
            <p><strong>Deadline: </strong>{{ project.deadline }}</p>
        {% endif %}

        {% if project.action %}
            <p><strong>Status: </strong>{{ project.action }}</p>
        {% endif %}

        {% if project.project_type %}
            <p><strong>Project type: </strong>{{ project.project_type }}</p>
        {% endif %}

        {% if project.visibility %}
            <p><strong>Visibility: </strong>{{ project.visibility }}</p>
        {% endif %}

        {% if project.location %}
            <p><strong>Location: </strong>{{ project.location }}</p>
        {% endif %}
    </section>

    <section>
        <h3>Required Skills</h3>
        <ul>
            {% for req_skill in project.required_skills_details.all %}
                <li>{{ req_skill.get_proficiency_level_display }}</li>
            {% empty %}
                <li>No specific skill mentioned.</li>
            {% endfor %}
        </ul>
    </section>

    <section>
        <h3>Chat</h3>
        <div id="chat-log">
        </div>
            <input type="text" id="chat-message-input">
            <button id="chat-message-submit">Send</button>
        <!-- <p>Chat functionality Coming Sonn...</p> -->
    </section>

    <section>
        <h3>Whiteboard</h3>
        <textarea id="whiteboard-content" style="width: 100%; height: 300px;">
            {{ whiteboard_content }}
        </textarea>
        <button id="save-whiteboard">Save Whiteboard</button>
        <div class="whiteboard-display"></div>
        <!-- <p>Collaborative Whiteboard/editor Coming Soon...</p> -->
    </section>

    <script>

        // Chat functionality with WebSocket

        const project_id = {{ project.id }};
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/project/'
            + project_id
            + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            document.querySelector('#chat-log').innerHTML += (`<div><strong>${data.user}</strong>: ${data.message}</div>`);
        };

        chatSocket.onclose = function(e) {
            console.error("Chat socket closed unexpectedly");
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };


        // Whiteboard functionality

        const whiteboardContent = document.querySelector('#whiteboard-content');
        const saveWhiteboardButton = document.querySelector('#save-whiteboard');
        const whiteboardDisplay = document.querySelector('#whiteboard-display');

        function renderWhiteboardContent(content) {
            let renderedContent = content;

            // Basic Markdown-like rendering
            renderedContent = renderedContent.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            renderedContent = renderedContent.replace(/\*(.+?)\*/g, '<em>$1</em>');
            renderedContent = renderedContent.replace(/__(.+?)__/g, '<u>$1</u>');
            renderedContent = renderedContent.replace(/_(.+?)_/g, '<i>$1</i>');
            renderedContent = renderedContent.replace(/## (.+?)$/gm, '<h3>$1</h3>');

            // Code block rendering (very basic)
            renderedContent = renderedContent.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

            // Image rendering (simplistic link-based)
            renderedContent = renderedContent.replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1">');

            whiteboardDisplay.innerHTML = renderedContent;
        }

        renderWhiteboardContent(whiteboardContent.value);

        whiteboardContent.addEventListener('input', function() {
            renderWhiteboardContent(this.value); // Real-time preview as you type 
        });

        saveWhiteboardButton.onclick = function() {
            const content = whiteboardContent.value;
            fetch(`/projects/${project_id}/whiteboard/save/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ 'content': content }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Whiteboard saved!');
                    // Optionally provide user feedback
                } else {
                    console.error('Error saving whiteboard:', data.error);
                }
            });
        };



    </script>

    
{% endblock %}

